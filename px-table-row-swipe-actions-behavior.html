<!--
<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.6/hammer.min.js"></script>
-->
<script src="../hammerjs/hammer.min.js"></script>
<script type="text/javascript">
  if (!window.Hammer) {
    console.error('Must provide hammer.js');
  }
  var reqAnimationFrame = (function () {
    return window[Hammer.prefixed(window, "requestAnimationFrame")] || function (callback) {
      setTimeout(callback, 1000 / 60);
    };
  })();

  function dirProp(direction, hProp, vProp) {
    return (direction & Hammer.DIRECTION_HORIZONTAL)
      ? hProp
      : vProp;
  }

  /**
  Swipe List Item Actions
  */
  function SwipeActions(container, direction) {
    var instance = container;
    this.container = container;
    this.direction = direction;

    console.log('SwipeActions.constructor', container, direction);

    console.log('Container children', container.children);

    this.actions = container.queryEffectiveChildren('px-table-row-actions');
    console.warn('SwipeActions', 'actions', this.actions);

    this.panes = Array.prototype.slice.call(this.container.querySelector('.table-row__content'), 0);
    //this.panes = 1;
    console.warn('SwipeActions', 'panes', this.panes);

    this.containerSize = this.container[dirProp(direction, 'offsetWidth', 'offsetHeight')];
    console.warn('SwipeActions', 'setting containerSize', this.containerSize);

    this.actionsSize = this.actions[dirProp(direction, 'offsetWidth', 'offsetHeight')];
    console.log('SwipeActions', 'setting actionsSize', this.actionsSize);

    this.currentIndex = 0;
    this.hammer = new Hammer.Manager(this.container);
    this.hammer.add(new Hammer.Pan({direction: this.direction, threshold: 10}));

    this.hammer.on("panstart panmove panend pancancel", Hammer.bindFn(this.onPan, this));
    console.log('SwipeActions', this);
    //console.warn('Actions size', this.actionsSize);
  }

  SwipeActions.prototype = {
    show: function (showIndex, percent, animate) {
      if (!this.panes.length) {
        this.panes.length = 2;
      }
      showIndex = Math.max(0, Math.min(showIndex, this.panes.length - 1));
      percent = percent || 0;
      var className = this.container.className;

      if (animate) {

        if (className.indexOf('animate') === -1) {
          this.container.className += ' animate';
        }
      } else {
        if (className.indexOf('animate') !== -1) {
          this.container.className = className.replace('animate', '').trim();
        }
      }

      var paneIndex,
        pos,
        translate;

      for (paneIndex = 0; paneIndex < this.panes.length; paneIndex++) {
        pos = (this.actionsSize / 100) * (((paneIndex - showIndex) * 100) + percent);
        pos = Math.round(pos);
        //  console.warn('pos', pos);
        if (this.direction & Hammer.DIRECTION_HORIZONTAL) {
          translate = 'translate3d(' + pos + 'px, 0, 0)';
        } else {
          translate = 'translate3d(0, ' + pos + 'px, 0)';
        }

        //this.container.transform(translate);
        this.actions.transform(translate);
        //this.panes[paneIndex].style.transform = translate; this.panes[paneIndex].style.mozTransform = translate; this.panes[paneIndex].style.webkitTransform = translate;

      }
      //console.log('translate', translate);

      this.currentIndex = showIndex;

      console.log('SwipeActions.show', 'translate', translate, 'showIndex', showIndex, 'positino', pos, 'percent', percent, 'animate', animate);

    },
    onPan: function (ev) {
      var delta = dirProp(this.direction, ev.deltaX, ev.deltaY);
      var percent = (100 / this.actionsSize) * delta;
      var animate = false;

      if (ev.type == 'panend' || ev.type == 'pancancel') {
        if (Math.abs(percent) > 5 && ev.type == 'panend') {
          this.currentIndex += (percent < 0)
            ? 1
            : -1;
        }
        percent = 0;
        animate = true;
      }
      //  console.log('SwipeActions.onPan', 'delta = ', delta, 'percent =', percent, animate);
      this.show(this.currentIndex, percent, animate);
    }
  };

  /*
  setTimeout(function(){
    console.log('Setting Up Hammer');
    Hammer.each(document.querySelectorAll(".table-row--actionable"), function(container) {
      var actions = new SwipeActions(container, Hammer.DIRECTION_HORIZONTAL);
      //outer.hammer.get('pan').requireFailure(actions.hammer.get('pan'));
      console.log('Adding Hammer', actions);
    });
  }, 2000);
  */

  /**
   * Behavior that manages the swipe actions
   *
   * @polymerBehavior
   */
  var pxTableRowActionsSwipeBehavior = {
    created: function () {
      if (this.actionable) {
        console.log('Before swipe handlers');
      }
    },
    attached: function () {
      if (this.actionable) {
        console.log('Adding swipe handlers');
        this._actions = new SwipeActions(this, Hammer.DIRECTION_HORIZONTAL);
      }

    }
  };
</script>
