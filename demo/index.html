<!DOCTYPE html>

<html>

  <head>
    <meta charset="UTF-8">
    <meta name="google" value="notranslate">


    <title>CodePen - pull to refresh</title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel='stylesheet prefetch' href='../../px-design-system/css/px-design-system.min.css'>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/webcomponentsjs/0.7.21/webcomponents.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>

    <script src='https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.6/hammer.min.js'></script>


    <!-- TODO: pxm components -->
    <link rel="import" href="../px-table-view.html">
    <link rel="import" href="../px-table-row-swipe-actions-behavior.html">
    <link rel="import" href="../../px-navbar/px-navbar.html" />
    <link rel="import" href="../../iron-ajax/iron-ajax.html" />
    <link rel="import" href="../../iron-list/iron-list.html" />

    <style media="screen">
    body {
      -webkit-overflow-scrolling: touch;
      padding-top: 65px;
    }
    
    px-navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 200;
    }
    
    #content {
      overflow-x: auto;
    }
    
    .flagged {
      background-color: orange !important;
    }
    
    .deleted {
      background-color: red !important;
    }
    
    .table-row__media--icon:nth-of-type(even) {}
    
    .table-row__media--icon:nth-child(2n) {
      color: #dd6b1f;
    }

    </style>



    <script type="text/javascript">
    if ('addEventListener' in document) {
      document.addEventListener('DOMContentLoaded', function() {
        FastClick.attach(document.body);
      }, false);
    }

    </script>


    <style>
    #ptr {
      position: absolute;
      top: 45px;
      left: 0;
      width: 100%;
      color: #fff;
      z-index: auto;
      text-align: center;
      height: 50px;
    }
    
    #ptr .icon {
      background-color: #3e87e8;
      opacity: .6;
      font-size: 34px;
      width: auto;
      height: auto;
      -webkit-transition: all .25s ease;
      transition: all .25s ease;
      -webkit-transform: rotate(90deg);
      transform: rotate(90deg);
      margin-top: 5px;
    }
    
    .ptr-refresh #ptr .icon {
      -webkit-transform: rotate(270deg);
      transform: rotate(270deg);
    }
    
    .ptr-loading #ptr .icon,
    .ptr-reset #ptr .icon {
      display: none;
    }
    
    .loading {
      display: inline-block;
      text-align: center;
      opacity: .4;
      margin: 12px 0 0 5px;
      display: none;
    }
    
    .loading span {
      display: inline-block;
      vertical-align: middle;
      width: 10px;
      height: 10px;
      margin-right: 3px;
      -webkit-transform: scale(0.3);
      transform: scale(0.3);
      border-radius: 50%;
      -webkit-animation: ptr-loading 0.3s infinite alternate;
      animation: ptr-loading 0.3s infinite alternate;
    }
    
    .ptr-loading .loading {
      display: block;
    }
    
    #l1 {
      -webkit-animation-delay: 0;
      animation-delay: 0;
    }
    
    #l2 {
      -webkit-animation-delay: 0.2s;
      animation-delay: 0.2s;
    }
    
    #l3 {
      -webkit-animation-delay: 0.3s;
      animation-delay: 0.3s;
    }
    
    @-webkit-keyframes ptr-loading {
      0% {
        -webkit-transform: translateY(0) scale(0.3);
        transform: translateY(0) scale(0.3);
        opacity: 0;
      }
      100% {
        -webkit-transform: scale(1);
        transform: scale(1);
        background: #3e87e8;
        opacity: 1;
      }
    }
    
    @keyframes ptr-loading {
      0% {
        -webkit-transform: translateY(0) scale(0.3);
        transform: translateY(0) scale(0.3);
        opacity: 0;
      }
      100% {
        -webkit-transform: scale(1);
        transform: scale(1);
        background: #3e87e8;
        opacity: 1;
      }
    }
    
    #content {
      min-height: 100%;
      z-index: 20;
      -webkit-backface-visibility: hidden;
      -webkit-perspective: 1000;
      box-sizing: border-box;
    }
    
    .ptr-loading #content,
    .ptr-reset #content,
    .ptr-loading #ptr,
    .ptr-reset #ptr {
      -webkit-transition: all .25s ease;
      transition: all .25s ease;
    }
    
    .ptr-reset #content {
      -webkit-transform: translate3d(0, 0, 0);
      transform: translate3d(0, 0, 0);
    }
    
    .ptr-loading #content {
      -webkit-transform: translate3d(0, 50px, 0);
      transform: translate3d(0, 50px, 0);
    }

    </style>




  </head>

  <body unresolved class="viewport viewport--full-height">

    <px-navbar title="px-table-view"></px-navbar>

    <div id="ptr">
      <div class="loading">
        <span id="l1"></span>
        <span id="l2"></span>
        <span id="l3"></span>
      </div>
    </div>

    <div id="content" class="">


      <template id="tableViewTemplate" is="dom-bind">
        <iron-ajax url="./data.json" last-response="{{data}}" auto></iron-ajax>
        <iron-list id="ironList" items="[[data]]" as="item" class="table-view  table-view--small">
          <template>
            <div class="table-row table-row--tappable table-row--actionable" on-tap="handleSelect">



              <div class="">
                <div class="table-row__media table-row__media--icon" hidden="{{!item.icon}}">
                  <i class$="{{item.icon}}"></i>
                </div>

                <div class="table-row__content">

                  <h4 class="table-row__content__title">{{item.title}}</h4>

                </div>

              </div>
              <div class="table-row__actions table-row__actions--right">

                <button on-tap="handleFlag" class="table-row__actions__button btn--full btn-flag">
                  <i class="fa fa-flag fa-lg"></i> Flag
                </button>

                <button on-tap="handleMore" class="table-row__actions__button btn--full btn-more">
                  More
                </button>

                <button on-tap="handleDelete" class="table-row__actions__button btn--full btn-delete">
                  Delete
                </button>
              </div>
            </div>
          </template>
        </iron-list>
      </template>
      <script type="text/javascript">
      var tmpl = document.getElementById('tableViewTemplate');
      tmpl.handleSelect = function(e) {
        console.log('handleSelect', e);
      };
      tmpl.handleMore = function(e) {
        console.log('handleMore', e);
      };
      tmpl.handleFlag = function(e) {
        console.log('handleFlag', e);
        $(e.currentTarget).parents('.table-row').toggleClass('flagged');
      };
      tmpl.handleDelete = function(e) {
        console.log('handleDelete', e);
        $(e.currentTarget).parents('.table-row').toggleClass('deleted');
      };
      document.addEventListener('WebComponentsReady', function() {
        setTimeout(function() {
          document.querySelector('iron-list').fire('iron-resize');
          Hammer.each(document.querySelectorAll(".table-row--actionable"), function(container) {
            var actions = new SwipeActions(container, Hammer.DIRECTION_HORIZONTAL);
            //outer.hammer.get('pan').requireFailure(actions.hammer.get('pan'));
            console.log('Adding Hammer', actions);
          });
        }, 50);
      });

      </script>


    </div>


    <script>
    var WebPullToRefresh = (function() {
      'use strict';

      /**
       * Hold all of the default parameters for the module
       * @type {object}
       */
      var defaults = {
        // ID of the element holding pannable content area
        contentEl: 'content',

        // ID of the element holding pull to refresh loading area
        ptrEl: 'ptr',

        // Number of pixels of panning until refresh
        distanceToRefresh: 70,

        // Pointer to function that does the loading and returns a promise
        loadingFunction: false,

        // Dragging resistance level
        resistance: 2.5
      };

      /**
       * Hold all of the merged parameter and default module options
       * @type {object}
       */
      var options = {};

      /**
       * Pan event parameters
       * @type {object}
       */
      var pan = {
        enabled: false,
        distance: 0,
        startingPositionY: 0
      };

      /**
       * Easy shortener for handling adding and removing body classes.
       */
      var bodyClass = document.body.classList;

      /**
       * Initialize pull to refresh, hammer, and bind pan events.
       *
       * @param {object=} params - Setup parameters for pull to refresh
       */
      var init = function(params) {
        params = params || {};
        options = {
          contentEl: params.contentEl || document.getElementById(defaults.contentEl),
          ptrEl: params.ptrEl || document.getElementById(defaults.ptrEl),
          distanceToRefresh: params.distanceToRefresh || defaults.distanceToRefresh,
          loadingFunction: params.loadingFunction || defaults.loadingFunction,
          resistance: params.resistance || defaults.resistance
        };

        if (!options.contentEl || !options.ptrEl) {
          return false;
        }

        var h = new Hammer(options.contentEl);

        h.get('pan').set({
          direction: Hammer.DIRECTION_VERTICAL
        });

        h.on('panstart', _panStart);
        h.on('pandown', _panDown);
        h.on('panup', _panUp);
        h.on('panend', _panEnd);
      };

      /**
       * Determine whether pan events should apply based on scroll position on panstart
       *
       * @param {object} e - Event object
       */
      var _panStart = function(e) {
        pan.startingPositionY = document.body.scrollTop;

        if (pan.startingPositionY === 0) {
          pan.enabled = true;
        }
      };

      /**
       * Handle element on screen movement when the pandown events is firing.
       *
       * @param {object} e - Event object
       */
      var _panDown = function(e) {
        if (!pan.enabled) {
          return;
        }

        e.preventDefault();
        pan.distance = e.distance / options.resistance;

        _setContentPan();
        _setBodyClass();
      };

      /**
       * Handle element on screen movement when the pandown events is firing.
       *
       * @param {object} e - Event object
       */
      var _panUp = function(e) {
        if (!pan.enabled || pan.distance === 0) {
          return;
        }

        e.preventDefault();

        if (pan.distance < e.distance / options.resistance) {
          pan.distance = 0;
        } else {
          pan.distance = e.distance / options.resistance;
        }

        _setContentPan();
        _setBodyClass();
      };

      /**
       * Set the CSS transform on the content element to move it on the screen.
       */
      var _setContentPan = function() {
        // Use transforms to smoothly animate elements on desktop and mobile devices
        options.contentEl.style.transform = options.contentEl.style.webkitTransform = 'translate3d( 0, ' + pan.distance + 'px, 0 )';
        options.ptrEl.style.transform = options.ptrEl.style.webkitTransform = 'translate3d( 0, ' + (pan.distance - options.ptrEl.offsetHeight) + 'px, 0 )';
      };

      /**
       * Set/remove the loading body class to show or hide the loading indicator after pull down.
       */
      var _setBodyClass = function() {
        if (pan.distance > options.distanceToRefresh) {
          bodyClass.add('ptr-refresh');
        } else {
          bodyClass.remove('ptr-refresh');
        }
      };

      /**
       * Determine how to animate and position elements when the panend event fires.
       *
       * @param {object} e - Event object
       */
      var _panEnd = function(e) {
        if (!pan.enabled) {
          return;
        }

        e.preventDefault();

        options.contentEl.style.transform = options.contentEl.style.webkitTransform = '';
        options.ptrEl.style.transform = options.ptrEl.style.webkitTransform = '';

        if (document.body.classList.contains('ptr-refresh')) {
          _doLoading();
        } else {
          _doReset();
        }

        pan.distance = 0;
        pan.enabled = false;
      };

      /**
       * Position content and refresh elements to show that loading is taking place.
       */
      var _doLoading = function() {
        bodyClass.add('ptr-loading');

        // If no valid loading function exists, just reset elements
        if (!options.loadingFunction) {
          return _doReset();
        }

        // The loading function should return a promise
        var loadingPromise = options.loadingFunction();

        // For UX continuity, make sure we show loading for at least one second before resetting
        setTimeout(function() {
          // Once actual loading is complete, reset pull to refresh
          loadingPromise.then(_doReset);
        }, 1000);
      };

      /**
       * Reset all elements to their starting positions before any paning took place.
       */
      var _doReset = function() {
        bodyClass.remove('ptr-loading');
        bodyClass.remove('ptr-refresh');
        bodyClass.add('ptr-reset');

        var bodyClassRemove = function() {
          bodyClass.remove('ptr-reset');
          document.body.removeEventListener('transitionend', bodyClassRemove, false);
        };

        document.body.addEventListener('transitionend', bodyClassRemove, false);
      };

      return {
        init: init
      }

    })();



    window._onload = function() {
      WebPullToRefresh.init({
        loadingFunction: exampleLoadingFunction
      });
    };

    // Just an example loading function that returns a
    // promise that WebPullToRefresh can use.
    var exampleLoadingFunction = function() {

      return new Promise(function(resolve, reject) {

        if (true) {

          resolve(document.getElementById('ironList').push('items', {
            title: 'Test ' + Date.now()
          }));
        } else {
          reject();
        }
      });
    };
    //@ sourceURL=pen.js

    </script>




  </body>

</html>
