<script>
	var log = function(cat, obj) {
		console.log(cat, obj);
	};
	/**
	 * Private class to have x-axis point and left flick status by checking a current and previous position
	 */
	var xPoint = function(x) {
		this.updated = false;
		this.x = this._prev = this._origin = x;
		this._timeStamp = (new Date()).getTime();
	};
	xPoint.prototype = {
		TIMER_RESET_THRESHOLD: -5 /* px */ ,
		VELOCITY_THRESHOLD: -0.2 /* px/ms */ ,
		distance: function() {
			// distance between touch start and current point
			return this.x - this._origin;
		},
		update: function(x) {
			// reset time stamp at move stop
			if (x - this.x > this.TIMER_RESET_THRESHOLD) {
				this._timeStamp = (new Date()).getTime();
				this._prev = this.x;
			}
			this.x = x;
			this.updated = true;
		},
		isFlick: function() {
			var dt = (new Date()).getTime() - this._timeStamp;
			var dx = this.x - this._prev;
			return (dx / dt) < this.VELOCITY_THRESHOLD;
		}
	};
	var px = window.px || {};
	px.behaviors = px.behaviors || {};
	var TableRowSwipeBehavior = {
		properties: {
			/**
			 * If true, the content will be opened by default
			 *
			 * @attribute open
			 * @type boolean
			 * @default false
			 */
			open: {
				type: Boolean,
				value: false
			},
			/**
			 * If true, drag (touch move) action is disabled and a content is automatically opened by click/touch
			 *
			 * @attribute nodrag
			 * @type boolean
			 * @default false
			 */
			nodrag: {
				type: Boolean,
				value: false
			},
			/**
			 * Offset pixcel position for opened state
			 *
			 * @attribute offset
			 * @type number
			 * @default 60
			 */
			offset: {
				type: Number,
				value: 40
			},
			/**
			 * If true, box shadow is added
			 *
			 * @attribute shadow
			 * @type boolean
			 * @default false
			 */
			shadow: {
				type: Boolean,
				value: false
			},
			/**
			 * If true, all gestures are disabled
			 *
			 * @attribute disabled
			 * @type boolean
			 * @default false
			 */
			disabled: {
				type: Boolean,
				value: false,
				observer: 'disabledChanged'
			}
		},
		handleClick: function(e) {
			this.fire('select', e);
		},
		disabledChanged: function(oldValue, newValue) {
			if (newValue) {
				this.open = false;
				this.transition();
				this.removeGestureListeners();
			}
		},
		handleUp: function(e) {
			if (this.nodrag) {
				this.toggleOpen();
			} else {
				this.onUp(e);
			}
		},
		handleDown: function(e) {
			this.onDown(e);
		},
		handleTrack: function(e) {
			if (this.disabled) {
				return;
			}
			switch (e.detail.state) {
				case 'track':
					this.onMove(e);
					break;
				case 'end':
					this.onUp(e);
					break;
			}
		},
		removeGestureListeners: function() {
			// do not need from Polymer 1.0 gensture events?
			// https://www.polymer-project.org/1.0/docs/devguide/events.html#gestures
		},
		onDown: function(e) {
			this.point = new xPoint(e.detail.x);
			this.applyClass();
		},
		onMove: function(e) {
			var p = this.point;
			if (p) {
				log('onMove', p.distance());
				p.update(e.detail.x);
				this.translate3d(this.open ? this.offset - this.$.content.clientWidth + p.distance() + "px" : p.distance() + "px", 0, 0, this.$.content);

			}
		},
		onUp: function(e) {
			var p = this.point;
			if (!p) {
				return;
			}
			this.open = p && p.isFlick();
			this.point = null;
			this.applyClass();
			// apply css fixed-true before transition
			this.async(this.transition);
			log('onUp', this.open, this);
		},
		transition: function() {
      var transitionPx = this.offset - this.$.content.clientWidth + "px";
      log('transition', transitionPx);
			this.translate3d(this.open ? transitionPx : 0, 0, 0, this.$.content);
		},
		toggleOpen: function() {
			this.open = !this.open;
			this.transition();
		},
		applyClass: function() {
			var list = ["style-scope swipe-content"]
			if (this.nodrag || this.point === null) {
				list.push("cubic-bezier");
			}
			log('applyClass', list);
			this.$.content.className = list.join(" ");
		},
		// must pass *same* function instance to both (add|remove)EventListener, so bind in created
		created: function() {
			this.toggleOpen = this.toggleOpen.bind(this);
			this.onDown = this.onDown.bind(this);
			this.onMove = this.onMove.bind(this);
			this.onUp = this.onUp.bind(this);
			//console.log(this.tagName, 'created');
		},
		ready: function() {
			this.applyClass();
			this.transition();
			// allow y scroll on this node but prevent x scroll
			this.setScrollDirection('y');
		},
		attached: function() {
			console.log(this.tagName, 'attached');
			this.listen( this.$.tableRow, 'track', 'handleTrack');
		},
		detached: function() {
			this.removeGestureListeners();
			console.log(this.tagName, 'detached');
		}
	};
</script>
